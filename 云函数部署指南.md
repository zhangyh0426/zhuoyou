# 🚀 云函数部署指南

## 📋 准备工作

### ✅ 您的云函数已准备完成：
- `userAuth` - 用户认证云函数
- `activityManager` - 活动管理云函数  
- `transactionManager` - 交易管理云函数
- `storeManager` - 店铺管理云函数

## 🔧 微信开发者工具部署步骤

### 步骤1：打开微信开发者工具
1. 打开微信开发者工具
2. 打开您的项目：`c:\Users\simonz\Desktop\jiqi\zhuoyou\`

### 步骤2：开启云开发
1. 点击右上角 **"云开发"** 按钮
2. 选择 **"开通云开发"**
3. 选择环境类型：
   - **测试环境**：用于开发测试
   - **生产环境**：用于正式发布
4. 点击 **"开通"**

### 步骤3：上传云函数
1. 右键点击 **云函数目录** (`cloudfunctions`)
2. 选择 **"上传并部署"**
3. 上传每个云函数：
   - `userAuth`
   - `activityManager`
   - `transactionManager` 
   - `storeManager`

### 步骤4：配置云函数权限
在云开发控制台中设置云函数调用权限：
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入您的云开发环境
3. 设置云函数安全规则（开发阶段可以设置为公开）

## 🗄️ 数据库配置

### 创建数据表
在云开发控制台中创建以下数据表：

1. **users** - 用户表
   ```sql
   phone (string) - 主键
   name (string)
   avatar_url (string)
   register_time (date)
   last_login_time (date)
   ```

2. **member_cards** - 会员卡表
   ```sql
   user_phone (string) - 关联users.phone
   balance (number)
   points (number)
   level (string)
   join_date (date)
   last_transaction_time (date)
   status (string)
   ```

3. **activities** - 活动表
   ```sql
   id (number) - 主键
   title (string)
   description (string)
   date (string)
   time (string)
   location (string)
   max_players (number)
   current_players (number)
   min_players (number)
   price (number)
   status (string)
   created_by (string)
   created_at (date)
   ```

4. **activity_participants** - 活动参与者表
   ```sql
   id (number) - 主键
   activity_id (number) - 关联activities.id
   user_phone (string) - 关联users.phone
   join_time (date)
   payment_status (string)
   ```

5. **transactions** - 交易记录表
   ```sql
   id (number) - 主键
   user_phone (string) - 关联users.phone
   type (string)
   amount (number)
   balance_after (number)
   description (string)
   reference_id (string)
   reference_type (string)
   status (string)
   created_at (date)
   ```

6. **store_status** - 店铺状态表
   ```sql
   id (number) - 主键
   is_open (boolean)
   open_time (string)
   close_time (string)
   last_update (date)
   message (string)
   ```

7. **admins** - 管理员表
   ```sql
   phone (string) - 主键
   name (string)
   role (string)
   permissions (array)
   created_at (date)
   created_by (string)
   ```

### 设置数据库权限
在云开发控制台中设置数据库访问权限：
- 开发阶段：设置为 "所有用户可读写"
- 生产阶段：设置安全规则，只允许认证用户访问

## 🧪 测试部署结果

### 测试云函数
在微信开发者工具中使用以下代码测试云函数：

```javascript
// 测试用户认证云函数
wx.cloud.callFunction({
  name: 'userAuth',
  data: {
    action: 'login',
    data: {
      phone: '13888888888',
      name: '测试用户'
    }
  }
}).then(res => {
  console.log('用户登录结果:', res);
});

// 测试活动管理云函数
wx.cloud.callFunction({
  name: 'activityManager',
  data: {
    action: 'getActivities'
  }
}).then(res => {
  console.log('活动列表:', res);
});
```

## 🔍 常见问题解决

### 问题1：云函数调用失败
**解决方法：**
- 检查云函数是否正确上传
- 确认云开发环境配置正确
- 查看云函数日志进行调试

### 问题2：数据库连接失败
**解决方法：**
- 确认数据库表结构正确
- 检查数据库权限设置
- 验证云开发环境ID配置

### 问题3：依赖包安装失败
**解决方法：**
- 检查package.json配置
- 确认Node.js版本兼容
- 重新上传云函数

## 📝 部署检查清单

- [ ] 开通云开发环境
- [ ] 上传所有云函数代码
- [ ] 创建数据库表结构
- [ ] 配置数据库权限
- [ ] 测试云函数调用
- [ ] 测试数据库操作
- [ ] 配置云函数安全规则
- [ ] 设置环境变量（如需要）

## 🎉 部署成功后

您的狼人杀桌游店小程序将获得：
- ✨ 完整的后端服务能力
- 🔄 实时数据同步
- 📊 交易记录管理
- 👥 用户认证系统
- 🎯 活动管理功能
- 🏪 店铺状态管理

需要我帮您完成其中某个步骤吗？